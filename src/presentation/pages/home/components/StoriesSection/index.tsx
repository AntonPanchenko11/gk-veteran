import { useCallback, useMemo, useState } from 'react'
import soldierImage from './assets/soldger.png'

type StorySource = {
  title: string
  content: string
  image?: string
}

class StoryEntity {
  private readonly paragraphsCache: string[]
  private readonly source: StorySource

  constructor(source: StorySource) {
    this.source = source
    this.paragraphsCache = this.splitIntoParagraphs(source.content)
  }

  get title() {
    return this.source.title
  }

  get image() {
    return this.source.image ?? soldierImage
  }

  get paragraphs() {
    return this.paragraphsCache
  }

  private splitIntoParagraphs(content: string) {
    return content
      .split(/\r?\n|\u2028|\u2029/)
      .map((paragraph) => paragraph.trim())
      .filter(Boolean)
  }
}

const STORY_SOURCES: ReadonlyArray<StorySource> = [
  {
    title: 'Академик',
    content:
      'Часть нашей команды, ветеран боевых действий с позывным «Академик». С 2012 по 2021 год находился на службе в правоохранительных органах. Ветеран боевых действий, участник СВО, патриот своей Земли и Отечества, любящий сын и заботливый отец. В различные периоды спецоперации, принимал активное участие в боевых действиях по отражению вооружённой агрессии Украины в отношении независимых Республик, а также по отстаиванию прав, свобод и интересов граждан новых государственных формирований Российской Федерации. Формирования, в которых проходил службу вели активные наступательные действия на Соледаро-Бахмустком направлении, в следствии чего, были освобождены такие населённые пункты как Соледар, Бахмут и Богдановка, Донецкой Народной Республики, после передислоцирован на Лисичанское направление. В период боевых действий получил ранение. За особые заслуги и достижения, награждён согласно указанию Главы Донецкой Народной Республики — Медалью за Отвагу, Президентом Российской Федерации — Орденом Мужества. Дополнительно представлен к награждению ещё одним Орденом Мужества. В команду ГК «Ветеран», был приглашён в ноябре 2024 года. С тех пор является частью большой семьи, осуществляет ряд организационных функций, занимается аналитической и редакторской деятельностью, а также отвечает за внедрение продуктов ГК «Ветеран» в организации различных форм собственности.',
  },
  {
    title: 'Удав',
    content:
      'Часть нашей команды, ветеран боевых действий с позывным «Удав». «Удав» встретил начало боевых действий 17-ти летним подростком в далёком 2014 году. Без лишних раздумий вступил в ряды «Народного ополчения Донбасса» где и начал свой боевой путь. В разные периоды времени «Удав» пробовал себя в различных ипостасях как на службе, так и в гражданских специальностях, но одно было неизменным с миром цифровых технологий он всегда был на – «ты». Начало спецоперации «Удав» встретил, находясь на работе в г. Москва. Первое время даже мысли не возникло ехать домой и вступать в ряды добровольцев, так как все надеялись, что СВО очень быстро закончится. В апреле 2022 года наш герой вернулся домой из Москвы, долгое время сомневался, нужен ли он там, на боевых действиях. В июне 2022 года, не взирая ни на что, принял решение уйти добровольцем, пошёл в военкомат и записался в добровольцы. В качестве командира штурмового взвода, принимал участие в активных боевых действиях, в таких населённых пунктах как Северодонецк, Лисичанск, Соледар, Северск. В ходе спецоперации, «Удав» был трижды ранен, в следствии чего получил инвалидность, но не упал духом. Согласно Указу Президента Российской Федерации награждён «Медалью за отвагу». Сегодня «Удав» – это часть команды аналитического и внедренческого отделов ГК «Ветеран». Принимает активное участие в тестировании продуктов компании, с последующим внедрением их в различные организации. Осуществляет обучение операторов информационных систем, собирает и обрабатывает фидбэк от наших клиентов.',
  },
  {
    title: 'Родосс',
    content:
      'Часть нашей команды, ветеран боевых действий с позывным «Родосс». Один из самых молодых и в тоже время один из самых перспективных сотрудников ГК «Ветеран». Представитель Республики Марий Эл. Профессиональный спортсмен, кандидат в мастера спорта по спортивному туризму и кандидат в мастера спорта по спортивному ориентированию. Образование – «Специалист по информационным системам». В январе 2024 года начал решать вопрос своего будущего. Решил устроиться на одну из авиабаз, расположенных в пригороде Йошкар-Олы. В последствии понял и решил для себя, что на авиабазе в полной мере не сможет раскрыть свой потенциал. Отец предложил поехать в зону спецоперации, чтобы присоединиться к нему и принять активное участие в развитии военной медицины вооружённых сил. Немного про отца «Родосса». Настоящий патриот, талантливый врач, который добровольцем отправился на военную службу в зону СВО, сотни спасённых его руками жизней бойцов и сегодня продолжают свой отсчёт. До этого он работал в частной клинике травматологом-ортопедом, оставив свой тёплый дом и большую семью, выбрал суровые реалии полевых госпиталей. В силу своего богатого жизненного и медицинского опыта, принадлежности к ветеранскому сообществу, является главным внештатным врачом-консультантом ГК «Ветеран». Вернёмся к нашему герою, 2 июля 2024 получил диплом по приобретённой специальности. Ранним утром 3 июля 2024 уже находился в аэропорту. С 4 июля 2024 года начал службу в зоне СВО, с целью развития системы военной медицины, что является крайне важным в нынешних реалиях. Сегодня «Родосс» – это часть ядра команды разработчиков ПО ГК «Ветеран», юный программист, который ежедневно совершенствует свои знания и навыки в IT-сфере, опытным путём, самообразованием и самодисциплиной.',
  },
  {
    title: 'Зубной',
    content:
      'Часть нашей команды, ветеран боевых действий с позывным «Зубной». В течение своей жизни, в профессиональной деятельности, периодически менял род занятий — то практиковал как стоматолог (специализация терапия и хирургия), то уходил в исследования фармакологических препаратов — чаще в клинические, реже в маркетинговые, где работал как менеджер. С 2021 по 2022 работал менеджером в глобальном международном проекте, связанным с исследованием нового лекарственного препарата. В проекте участвовал практически весь мир — от Австралии с Японией до России с Украиной и всей Европы. Все менеджеры проекта находились в плотном общении друг с другом. Когда в мире начались глобальные сдвиги, наш герой увидел истинную личину вчерашних «партнёров» и с радостью принял известие о том, что Россия выходит из проекта. На это ушёл ещё год, и в конце зимы 2023 года «Зубной» решил связать судьбу с частной военной компанией России, блестяще зарекомендовавшей себя в спецоперации. На СВО он шёл как рядовой штурмовик, однако, изучив его личное дело, руководство компании определило его в медицинскую службу, чтобы специалист спасал жизни бойцов. В особые заслуги «Зубного» можно отнести то, что он неоднократно в полевых условиях из подручных и гуманитарных средств разворачивал работу стоматологических кабинетов, где лично лечил и оперировал. Сегодня «Зубной» — старший аналитик аналитического отдела ГК «Ветеран», человек, который буквально живёт продуктами компании: формирует ТЗ разработчикам, тестирует решения, выявляет баги и ошибки, помогая доводить сервисы до совершенства.',
  },
]

function buildStoryEntities(sources: ReadonlyArray<StorySource>) {
  return sources.map((source) => new StoryEntity(source))
}

function useStoryAccordion(stories: StoryEntity[]) {
  const [openedTitle, setOpenedTitle] = useState<string>('')

  const toggle = useCallback((title: string) => {
    setOpenedTitle((current) => (current === title ? '' : title))
  }, [])

  return { openedTitle, toggle }
}

function StoryContent({ story }: { story: StoryEntity }) {
  return (
    <div className="space-y-3 text-sm leading-relaxed text-wight">
      {story.paragraphs.map((paragraph, index) => (
        <p key={index}>{paragraph}</p>
      ))}
    </div>
  )
}

type StoryAccordionItemProps = {
  story: StoryEntity
  isActive: boolean
  onToggle: (title: string) => void
}

function StoryAccordionItem({ story, isActive, onToggle }: StoryAccordionItemProps) {
  return (
    <button
      type="button"
      onClick={() => onToggle(story.title)}
      aria-expanded={isActive}
      className={`flex w-full flex-1 flex-col gap-4 rounded-[1.25rem] border bg-surface-base px-6 py-5 text-left transition ${
        isActive
          ? 'border-highlight/60 text-white shadow-[0_15px_25px_-20px_rgba(0,0,0,0.6)]'
          : 'border-surface-muted/15 text-white hover:border-highlight/30 hover:bg-surface-section/60'
      }`}
    >
      <span className="flex items-center justify-between gap-4 text-lg font-semibold">
        {story.title}
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="1.5"
          className={`h-5 w-5 flex-none transition ${isActive ? 'rotate-180 text-highlight' : 'text-white/40'}`}
        >
          <path d="M6 9l6 6 6-6" />
        </svg>
      </span>
      {isActive ? (
        <div className="flex flex-col gap-6 lg:flex-row lg:gap-8">
          <div className="flex-2">
            <StoryContent story={story} />
          </div>
          <div className="mt-auto flex justify-end lg:mt-0 lg:flex-1 lg:items-end lg:justify-end">
            <img
              src={story.image}
              alt=""
              aria-hidden="true"
              className="h-[300px] w-[300px] flex-none rounded-2xl object-contain p-6"
            />
          </div>
        </div>
      ) : null}
    </button>
  )
}

function StoryAccordion({ stories }: { stories: StoryEntity[] }) {
  const { openedTitle, toggle } = useStoryAccordion(stories)

  return (
    <div className="flex h-full flex-col gap-3 rounded-3xl bg-surface-base p-3">
      {stories.map((story) => (
        <StoryAccordionItem key={story.title} story={story} isActive={story.title === openedTitle} onToggle={toggle} />
      ))}
    </div>
  )
}

function StoriesIntro() {
  return (
    <div className="space-y-6">
      <h2 className="heading-section mb-10">Истории</h2>
      <div className="space-y-4 text-white">
        <p className="body-text text-white">
          Предлагаем вам ближе познакомиться с командой группы компаний «ВЕТЕРАН». Наша миссия — это создание
          инновационных IT-решений, основанных на богатом опыте и профессионализме команды. Мы — команда
          высококвалифицированных специалистов, объединивших боевой опыт и технические знания для развития современных
          технологий.
        </p>
        <p className="body-text text-white">
          Основатели компании — ветераны боевых действий, прошедшие суровые испытания и доказавшие свою любовь к Родине
          и способность работать в экстремальных условиях. Наш боевой опыт научил нас дисциплине, ответственности и
          умению находить решения в самых сложных ситуациях. Эти качества мы привносим в каждый проект, над которым
          работаем.
        </p>
        <div className="rounded-2xl p-4 text-white">
          <h3 className="text-sm font-semibold uppercase tracking-[0.25em] text-highlight/80">
            Ключевые принципы нашей работы:
          </h3>
          <ul className="mt-3 space-y-2">
            <li className="relative pl-5 before:absolute before:left-0 before:top-2 before:h-1.5 before:w-1.5 before:rounded-full before:bg-highlight/80">
              <span className="body-text text-white">Надёжность и безопасность — мы гарантируем стабильность и защиту ваших данных;</span>
            </li>
            <li className="relative pl-5 before:absolute before:left-0 before:top-2 before:h-1.5 before:w-1.5 before:rounded-full before:bg-highlight/80">
              <span className="body-text text-white">Эффективность и качество — используем передовые технологии и лучшие практики;</span>
            </li>
            <li className="relative pl-5 before:absolute before:left-0 before:top-2 before:h-1.5 before:w-1.5 before:rounded-full before:bg-highlight/80">
              <span className="body-text text-white">Клиентоориентированность — стремимся понимать и решать задачи наших заказчиков;</span>
            </li>
            <li className="relative pl-5 before:absolute before:left-0 before:top-2 before:h-1.5 before:w-1.5 before:rounded-full before:bg-highlight/80">
              <span className="body-text text-white">Профессионализм — постоянно развиваемся и совершенствуем свои навыки.</span>
            </li>
          </ul>
        </div>
        <p className="body-text text-white">
          Наша цель — создание IT-решений, которые помогают бизнесу расти и развиваться. Мы верим, что наш уникальный
          опыт и технические компетенции позволят нам стать надёжным партнёром для наших клиентов. Мы создаём будущее
          технологий вместе с вами, опираясь на принципы чести, дисциплины и профессионализма.
        </p>
        <p className="body-text text-white">
          Ниже мы представляем вашему вниманию реальные истории из судеб, членов нашей большой семьи, с целью
          познакомится и показать кто мы есть на самом деле, обычные парни, которые не хотят хайпа или пиара на войне,
          парни, которые отдали своё здоровье, молодость и время для служения Отечеству. Мы не намерены останавливаться
          на достигнутом и несмотря ни на что, мы не перестанем делать этот Мир — лучше!
        </p>
        <p className="body-text text-white">И так знакомьтесь наши ветераны…</p>
      </div>
    </div>
  )
}

export function StoriesSection() {
  const stories = useMemo(() => buildStoryEntities(STORY_SOURCES), [])

  return (
    <section id="stories" className="bg-surface-section">
      <div className="mx-auto max-w-6xl px-6 py-10 lg:px-12 lg:py-14">
        <div className="flex flex-col gap-12">
          <StoriesIntro />
          <StoryAccordion stories={stories} />
        </div>
      </div>
    </section>
  )
}
